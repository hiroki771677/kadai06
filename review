<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Map&amp;Geolocation</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>

  <!-- MapArea -->
  <div id="view"></div>
  <div id="myMap" style="width:80%;height:100%;"></div>
  <div style="width:20%;float:right;padding-top: 5%;">
    <div id="output"></div>
    <div> å ´æ‰€ï¼š<input type="text" id="uname">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¨˜å…¥</div>
    <div>
        <textarea id="text" cols="30" rows="10" style="width:95%;"></textarea>
        <button id="send">é€ä¿¡</button>
    </div>

</div>
  <!-- /MapArea -->

     <!-- JQuery -->
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
     <!-- JQuery -->
 
     <!--** ä»¥ä¸‹Firebase **-->
     <script type="module">
         // Import the functions you need from the SDKs you need
         import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
 
         // è²¼ã‚Šä»˜ã‘ã‚‹å ´æ‰€
         import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
         // 
 
 
         // TODO: Add SDKs for Firebase products that you want to use
         // https://firebase.google.com/docs/web/setup#available-libraries
 
         // Your web app's Firebase configuration
         const firebaseConfig = {

   };
 
 
         // Initialize Firebase
         const app = initializeApp(firebaseConfig);
 
         // ã“ã®è¾ºã‚Šã«æ›¸ã„ã¦ã„ãã¾ã™
 
 
         const db = getDatabase(app);
         const dbRef = ref(db, 'dev245');
 
         // é€ä¿¡å‡¦ç†ã‚’è¨˜è¿°
         $('#send').on('click', function () {
 
             // id="uname" ã®å ´æ‰€ã‚’å–å¾—ã—ã¾ã™ğŸ¤—
             const uname = $('#uname').val();
             // console.log(uname, 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã®ä»•æ–¹ã§è¡¨ç¤ºãŒç•°ãªã‚‹ã®ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ğŸ¤—')
 
             // id="text" ã®å ´æ‰€ã‚’å–å¾—ã—ã¾ã™ğŸ¤—
             const text = $('#text').val();
             // console.log(text, 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã®ä»•æ–¹ã§è¡¨ç¤ºãŒç•°ãªã‚‹ã®ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ğŸ¤—')
 
             // å–å¾—ã§ãã¦ã„ã‚‹ã‹è¡¨ç¤ºã®ç¢ºèªã‚’ã—ã¾ã—ã‚‡ã†ï¼
             // ã“ã‚Œå¿…é ˆï¼ è¡¨ç¤ºã®ç¢ºèªãŒã§ãã¦æ–¹ã¯alertã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãŠãã¾ã—ã‚‡ã†ğŸ¤—
             // alert(uname + text);
 
 
             // ãƒ‡ãƒ¼ã‚¿ã®å¡Šã‚’ä½œã‚Šã¾ã™ğŸ¤—
             // msg ã¨ã„ã†åå‰ã§å¡Šã‚’ä½œã‚Šã¾ã™
             // unameã¨ã„ã†éµã®åå‰
             // textã¨ã„ã†ã‚«ã‚®ã®åå‰
             // ä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã®å¡Šã‚’firebaseã«é€ä¿¡ã‚’ã—ã¾ã™â‡¨ã¤ã¾ã‚Šã“ã‚ŒãŒä¿å­˜ã«ãªã‚Šã¾ã™ğŸ¤—
             const msg = {
                 uname: uname,
                 text: text,
             }
 
             // firebaseã«é€ã‚‹æº–å‚™ã‚’ã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ğŸ¤—
             const newPostRef = push(dbRef) //ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã§ãã‚‹æº–å‚™
             set(newPostRef, msg); // firebaseã®ç™»éŒ²ã§ãã‚‹å ´æ‰€ã«ä¿å­˜ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ğŸ¤—
 
             // é€ä¿¡å¾Œã«ã€å…¥åŠ›æ¬„ã‚’ç©ºã«ã—ã¾ã—ã‚‡ã†ğŸ¤—
             $('#uname').val("");
             $('#text').val("");
 
             // ã“ã‚Œã‚’ä½¿ã†ã¨ã©ã†ãªã‚‹ã‹ã¿ã¦ã¿ã¾ã—ã‚‡ã†ğŸ¤—
             $("#uname").focus();
 
             // sendé€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ ã“ã®ä¸‹æ¶ˆã•ãªã„
         });
 
 
         $("#text").on('keydown', function (e) {
             console.log(e, 'ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã®å¡Š')
             console.log(e.keyCode, 'ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã®å¡Š')
             // ã“ã®ä¸‹æ¶ˆã•ãªã„ã€€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’æŠ¼ã—ãŸæ™‚ã®ã‚¯ãƒªãƒƒã‚¯
         });
 
         // å—ä¿¡å‡¦ç†ã‚’è¨˜è¿°
         onChildAdded(dbRef, function (data) {
             // ã“ã“ã‹ã‚‰ãŒå—ä¿¡å‡¦ç†ãŒå§‹ã¾ã‚Šã¾ã™
 
             // ç™»éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ğŸ¤—
             const msg = data.val();
             console.log(msg, 'å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®å¡Š')
             const key = data.key;
             console.log(key, 'ãƒ‡ãƒ¼ã‚¿ã®å¡Šã«ã‚¢ã‚¯ã‚»ã‚¹')
 
 
             // es6ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«
             let h = `
                 <div class="msg">
                     <p>${msg.uname}</p>
                     <p>${msg.text}</p>
                 </div>    
             `;
             // htmlã«åŸ‹ã‚è¾¼ã¿ã¾ã—ã‚‡ã†ğŸ¤—
             // append();ã¨ã„ã†jqueryã®ãŠã¾ã˜ãªã„ã‚’ä½¿ã„ã¾ã™
            // $("#output").append(h);
         })
 
 
 
         // ã“ã®é–“ã«æ›¸ã„ã¦ã„ãã¾ã™
 
     </script>
 
  <!-- jQuery&GoogleMapsAPI -->
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=AuQrFmW2xbnHsgV5PfO-ifzWI5Puoaww4yyMe8Uv3JhrVbCd9xSESdW6sK6m92px' async
    defer></script>
  <script src="js/BmapQuery.js"></script>
  <script>
    //****************************************
    //æˆåŠŸé–¢æ•°
    //****************************************
    let map;

    function mapsInit(position) {
      //lat=ç·¯åº¦ã€lon=çµŒåº¦ ã‚’å–å¾—
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      //Mapè¡¨ç¤º
      map = new Bmap("#myMap");
      map.startMap(lat, lon, "load", 20); //The place is Bellevue.
      //Pinã‚’è¿½åŠ 
      let pin = map.pin(lat, lon, "#ff0000");
      //Infoboxã‚’è¿½åŠ 
      map.infobox(lat, lon, "ã‚¿ã‚¤ãƒˆãƒ«", '<div id="title"></div>');
    };

    //****************************************
    //å¤±æ•—é–¢æ•°
    //****************************************
    function mapsError(error) {
      let e = "";
      if (error.code == 1) { //1ï¼ä½ç½®æƒ…å ±å–å¾—ãŒè¨±å¯ã•ã‚Œã¦ãªã„ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šï¼‰
        e = "ä½ç½®æƒ…å ±ãŒè¨±å¯ã•ã‚Œã¦ã¾ã›ã‚“";
      }
      if (error.code == 2) { //2ï¼ç¾åœ¨åœ°ã‚’ç‰¹å®šã§ããªã„
        e = "ç¾åœ¨ä½ç½®ã‚’ç‰¹å®šã§ãã¾ã›ã‚“";
      }
      if (error.code == 3) { //3ï¼ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹å‰ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ãªã£ãŸå ´åˆ
        e = "ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹å‰ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ãªã‚Šã¾ã—ãŸ";
      }
      alert("ã‚¨ãƒ©ãƒ¼ï¼š" + e);
    };

    
    //****************************************
    //ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š
    //****************************************
    const set = {
      enableHighAccuracy: true, //ã‚ˆã‚Šé«˜ç²¾åº¦ãªä½ç½®ã‚’æ±‚ã‚ã‚‹
      maximumAge: 20000, //æœ€å¾Œã®ç¾åœ¨åœ°æƒ…å ±å–å¾—ãŒ20ç§’ä»¥å†…ã§ã‚ã‚Œã°ãã®æƒ…å ±ã‚’å†åˆ©ç”¨ã™ã‚‹è¨­å®š
      timeout: 10000 //10ç§’ä»¥å†…ã«ç¾åœ¨åœ°æƒ…å ±ã‚’å–å¾—ã§ããªã‘ã‚Œã°ã€å‡¦ç†ã‚’çµ‚äº†
    };

    //æœ€åˆã«å®Ÿè¡Œã™ã‚‹é–¢æ•°
    function GetMap() {
      navigator.geolocation.getCurrentPosition(mapsInit, mapsError, set);
    }
  </script>
  

</body>

</html>
